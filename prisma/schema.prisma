generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Resource {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name                       String
  role                       UserRole                    @default(USER)
  email                      String
  phone                      String
  location                   String?
  expertise                  String[]
  startTime                  DateTime?
  endTime                    DateTime?
  workingDays                String[]
  notes                      String?
  profileImage               String?
  password                   String?
  resetToken                 String?
  resetExpires               DateTime?
  isPasswordChanged          Boolean?                    @default(false)
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  resourceAvailabilities     ResourceAvailability[]
  resourceEnergies           ResourceEnergy[]
  availabilityChangeRequests AvailabilityChangeRequest[]
  projectAssignments         ProjectAssignment[]

  @@unique([email])
  @@unique([phone])
  @@map("users")
}

enum UserRole {
  ADMIN
  SUPER_ADMIN
  USER
  TEACHER
}

model WorkSchedule {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  startTime String // "09:00"
  endTime   String // "17:00"

  workingDays WorkingDay[] // relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_schedules")
}

model WorkingDay {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  day      WeekDay
  isActive Boolean @default(true)

  scheduleId String       @db.ObjectId
  schedule   WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, day])
  @@map("working_days")
}

enum WeekDay {
  M
  T
  W
  TH
  F
  S
  SU
}

model AvailabilityState {
  id                         String                      @id @default(auto()) @map("_id") @db.ObjectId
  key                        AvailabilityKey             @default(AVAILABLE)
  availabilityPercentage     Int                         @default(100)
  description                String?
  color                      String // hex: "#22c55e", "#facc15", "#ef4444"
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  resourceAvailabilities     ResourceAvailability[]
  availabilityChangeRequests AvailabilityChangeRequest[]

  @@unique([key])
  @@map("availability_states")
}

enum AvailabilityKey {
  AVAILABLE
  PARTIAL
  FULLY_BOOKED
}

model EnergyLevel {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  key         EnergyKey
  description String?
  color       String // hex color e.g. "#2563eb"

  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  resourceEnergies           ResourceEnergy[]
  availabilityChangeRequests AvailabilityChangeRequest[]

  @@unique([key])
  @@map("energy_levels")
}

enum EnergyKey {
  HIGH
  MEDIUM
  LOW
  RECOVERY
}

model ProjectPhase {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         PhaseKey
  description String?
  color       String // hex color e.g. "#4f46e5"

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  projectPhaseTimelines ProjectPhaseTimeline[]
  projectAssignments    ProjectAssignment[]

  @@unique([key])
  @@map("project_phases")
}

enum PhaseKey {
  PITCH
  PRODUCTION
  EVENT_DAYS
  WRAP_UP
}

model ProjectStatus {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  key         ProjectStatusKey
  description String?
  color       String // hex color e.g. "#22c55e"

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]

  @@unique([key])
}

enum ProjectStatusKey {
  PRODUCTION
  SPECULATION
  CANCELLED
}

model ResourceAvailability {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  resourceId String   @db.ObjectId
  date       DateTime

  availabilityId String            @db.ObjectId
  availability   AvailabilityState @relation(fields: [availabilityId], references: [id])

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceId, date])
  @@map("resource_availability")
}

model ResourceEnergy {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  resourceId String   @db.ObjectId
  date       DateTime

  energyId String      @db.ObjectId
  energy   EnergyLevel @relation(fields: [energyId], references: [id])

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceId, date])
  @@map("resource_energy")
}

model Project {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  customerName   String
  projectName    String
  projectCode    String        @unique
  projectType    String
  location       String?
  statusId       String        @db.ObjectId
  status         ProjectStatus @relation(fields: [statusId], references: [id], onDelete: Cascade)
  winProbability Int           @default(0)
  estimatedValue Float         @default(0.0)
  currency       String

  phases ProjectPhaseTimeline[]

  createdBy          String              @db.ObjectId
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  projectAssignments ProjectAssignment[]

  @@map("projects")
}

model ProjectPhaseTimeline {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  projectId String @db.ObjectId
  phaseId   String @db.ObjectId

  startDate DateTime
  endDate   DateTime

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  phase ProjectPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@unique([projectId, phaseId])
  @@map("project_phase_timeline")
}

model AvailabilityChangeRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // ===== Who & When =====
  resourceId String   @db.ObjectId
  date       DateTime

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  // ===== Requested Changes =====
  requestedAvailabilityId String?            @db.ObjectId
  requestedAvailability   AvailabilityState? @relation(fields: [requestedAvailabilityId], references: [id])

  requestedEnergyId String?      @db.ObjectId
  requestedEnergy   EnergyLevel? @relation(fields: [requestedEnergyId], references: [id])

  // ===== Approval Workflow =====
  status RequestStatus @default(PENDING)
  reason String?

  approvedBy String?   @db.ObjectId // admin id
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId, date])
  @@map("availability_change_requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model ProjectAssignment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  projectId  String @db.ObjectId
  resourceId String @db.ObjectId
  phaseId    String @db.ObjectId

  project  Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resource Resource     @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  phase    ProjectPhase @relation(fields: [phaseId], references: [id] , onDelete: Cascade)

  allocation Int? // % allocation for THIS PHASE (0â€“100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, resourceId, phaseId])
  @@map("project_assignments")
}
